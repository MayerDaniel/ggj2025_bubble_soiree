<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Example</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>
<body class="bg-light">
    <div class="container py-5">
        <h1 class="text-center mb-4">WebSocket Chat</h1>
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="submit-tab" data-bs-toggle="tab" data-bs-target="#submit" type="button" role="tab" aria-controls="submit" aria-selected="true">Submit</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="answer-tab" data-bs-toggle="tab" data-bs-target="#answer" type="button" role="tab" aria-controls="answer" aria-selected="false">Answer</button>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane show active" id="submit" role="tabpanel" aria-labelledby="submit-tab">
                <div class="mt-3">
                    <label for="messageType" class="form-label">Select Type</label>
                    <select id="messageType" class="form-select" onchange="updateForm()">
                        <option value="question" selected>Question</option>
                        <option value="poll">Poll</option>
                        <option value="announcement">Announcement</option>
                    </select>
                    <div id="formContainer" class="mt-3"></div>
                    <button onclick="handleSend()" class="btn btn-primary mt-3">Send</button>
                </div>
            </div>
            <div class="tab-pane" id="answer" role="tabpanel" aria-labelledby="answer-tab">
                <div id="messages" class="mt-3"></div>
                <input type="text" id="textInput" class="form-control mb-2" placeholder="Enter your message">
                <button onclick="handleSend()" class="btn btn-primary">Send</button>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script>
        let socket;
        function connect() {
            socket = new WebSocket("ws://localhost:8000/ws");
            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                document.getElementById("messages").innerHTML += `<p>${data.message}</p>`;
            };
            socket.onclose = () => alert("WebSocket closed");
        }
    
        function sendAnnouncement() {
            const announcement = document.getElementById("textInput").value;
            const message = { 
                type: "announcement",
                announcement: announcement,
            };
            socket.send(JSON.stringify(message));
            document.getElementById("textInput").value = ""; // Clear the input after sending
        }
    
        function sendQuestion() {
            const question = document.getElementById("textInput").value;
            const message = { 
                type: "question",
                question: question,
            };
            socket.send(JSON.stringify(message));
            document.getElementById("textInput").value = ""; // Clear the input after sending
        }
    
        function sendPoll() {
            const question = document.getElementById("textInput").value; // Assuming question input ID is "textInput"
            const answers = {};
            const answerContainer = document.getElementById("pollAnswersContainer"); // The container holding all the poll answers

            if (!question.trim()) {
                alert("Please enter a question.");
                return;
            }

            // Loop through all inputs in the pollAnswersContainer to collect answers
            const inputs = answerContainer.querySelectorAll("input");
            inputs.forEach((input, index) => {
                const answerValue = input.value.trim();
                if (answerValue) {
                    answers[index] = answerValue; // Add the answer to the dictionary with a sequential key
                }
            });

            if (Object.keys(answers).length === 0) {
                alert("Please provide at least one poll answer.");
                return;
            }

            // Create the message object
            const message = {
                type: "poll",
                question: question,
                answers: answers,
            };

            // Send the message via WebSocket
            socket.send(JSON.stringify(message));

            // Clear the input fields after sending
            document.getElementById("textInput").value = ""; // Clear question input
            inputs.forEach((input) => {
                input.value = ""; // Clear all answer inputs
            });
        }
    
        function handleSend() {
            const type = document.getElementById("messageType").value;
            if (type === "question") {
                sendQuestion();
            } else if (type === "poll") {
                sendPoll();
            } else if (type === "announcement") {
                sendAnnouncement();
            }
        }
    
        function updateForm() {
            const type = document.getElementById("messageType").value;
            const formContainer = document.getElementById("formContainer");
            formContainer.innerHTML = "";

            const textInput = `
                <div class="mb-3">
                    <label for="textInput" class="form-label">Question</label>
                    <input type="text" id="textInput" class="form-control">
                </div>
            `;

            if (type === "poll") {
                formContainer.innerHTML = textInput;

                const answerContainer = document.createElement("div");
                answerContainer.id = "pollAnswersContainer";
                formContainer.appendChild(answerContainer);

                // Start with 3 poll answers
                for (let i = 1; i <= 2; i++) {
                    addPollAnswerInput(answerContainer, i);
                }

                // Add a button to create more answers
                const addButton = document.createElement("button");
                addButton.type = "button";
                addButton.className = "btn btn-secondary mt-3";
                addButton.innerText = "Add More Options";
                addButton.onclick = () => {
                    const currentCount = answerContainer.children.length;
                    addPollAnswerInput(answerContainer, currentCount + 1);
                };

                formContainer.appendChild(addButton);
            } else if (type === "announcement" || type === "question") {
                formContainer.innerHTML = textInput;
            }
        }

        function addPollAnswerInput(container, index) {
            const answerDiv = document.createElement("div");
            answerDiv.className = "mb-3";
            answerDiv.innerHTML = `
                <label for="pollAnswer${index}" class="form-label">Poll Answer ${index}</label>
                <input type="text" id="pollAnswer${index}" class="form-control">
            `;
            container.appendChild(answerDiv);
        }
    
        connect();
        updateForm();
    </script>